<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>NF AC300A test result</title>
	<script src="https://code.jquery.com/jquery-3.6.3.min.js"></script>
	<link rel="stylesheet" type="text/css" href="/css/testResultStyle.css">
</head>

<body>

<div class="leftDiv">

	<form id="myForm"  onsubmit="return false;" method="post">

		<table class="select-table">
			
			<tr>
				<td class="widgets-table">機種:</td>
			</tr>
			<tr>
				<td >  
					<div class="select" id="productDiv"></div>
				</td>
			</tr>
			
			<tr>
				<td class="widgets-table">極數:</td>
			</tr>
			<tr>
				<td >
					<div class="select" id="poleNumDiv">
						<label><input type="checkbox" name="poleNum" id=poleNumSelected value="2P" onchange="submitForm();">2P</label><br>
						<label><input type="checkbox" name="poleNum" id=poleNumSelected value="3P" onchange="submitForm();">3P</label><br>
						<label><input type="checkbox" name="poleNum" id=poleNumSelected value="4P" onchange="submitForm();">4P</label><br>
					</div>
				</td>

			</tr>
			
			<tr>
				<td class="widgets-table">安培數:</td>
			</tr>
			<tr>
				<td >
					<div class="select" id="ammeterDiv"></div>
				</td>

			</tr>
			
			<tr>
				<td class="widgets-table">試驗人員:</td>
			</tr>
			<tr>
				<td >
					<div class="select" id="testPersonDiv">
					</div>
				</td>

			</tr>
			
			<tr>
				<td class="widgets-table">結果:</td>
			</tr>
			<tr>
				<td>
					<div class="select" id="resultDiv">
						<label><input type="checkbox"  name="result" id="resultPass" value="合格" onchange="submitForm()" checked/>合格</label><br>
						<label><input type="checkbox" name="result" id="resultFail" value="不合格" onchange="submitForm()"/>不合格</label><br>
					</div>
				</td>
			</tr>
			
			<tr>
				<td class="widgets-table">試驗日期:</td>
			</tr>
			<tr>
				<td>
			        <input type="date" id="startDateSelected" name="start-date" onchange="submitForm()"> ~ 
			        <input type="date" id="endDateSelected" name="end-date" onchange="submitForm()">
				</td>
			</tr>
			

		</table>
		
		<!--  <input type="submit" value="搜尋"><br>-->

	</form>
</div>

<div id="tableDiv" class="rightDiv"></div>

<script type="text/javascript">

	$(document).ready(function() {
		submitForm();
	});
	
	var productTypeList = new Array(); // 建立初始陣列, 存放每一個產品
	var ammeterList = new Array(); // 建立初始陣列, 存放每一個安培數
	var testPersonList = new Array(); // 建立初始陣列, 存放每一個試驗人員
	
	
	var finishedTestDate = new Array();; // 建立初始變數, 存放試驗日期
	
	
	
	//自訂submitForm()方法, 利用ajax的serialize()方法, 可將表單內容送到後端
	function submitForm() {
		
		var productSelected = new Array(); // 建立初始陣列, 存放選取後的產品
		var ammeterSelected = new Array(); // 建立初始陣列, 存放選取後的安培數
		var testPersonSelected = new Array(); // 建立初始陣列, 存放選取後的測試人員
		var poleNumSelected = new Array(); // 建立初始陣列, 存放選取後的極數
		var resultSelected = new Array(); // 建立初始陣列, 存放選取後的結果
		var finishedDateSelected = new Array(); // 建立初始陣列, 存放選取後的完成日期
		
		var jsonArray = new Array(); // 建立初始陣列, 存放待轉成 json 格式的Array
		
		// ========== 從ProductType的檢核方塊取得元素, 如有前端有被checked, 則會將內容存到陣列裡 ==========
		var productDiv = document.getElementById("productDiv");
		var productChecks = productDiv.querySelectorAll("input[type='checkbox']");

        for (var i = 0; i < productChecks.length; i++){
        	if (productChecks[i].checked == true){
        		productSelected.push(productChecks[i].value);
        		//console.log(productChecks[i].value);
        	}
        }
		console.log("選取的產品: " + productSelected);
		
		// ========== 從ammeter的檢核方塊取得元素, 如有前端有被checked, 則會將內容存到陣列裡 ==========
		var ammeterDiv = document.getElementById("ammeterDiv");
		var ammeterChecks = ammeterDiv.querySelectorAll("input[type='checkbox']");
		
        for (var i = 0; i < ammeterChecks.length; i++){
        	if (ammeterChecks[i].checked == true){
        		ammeterSelected.push(ammeterChecks[i].value);
        		
        	}
        }
		console.log("選取的安培數: " + ammeterSelected);
		
		
		// ========== 從testPerson的檢核方塊取得元素, 如有前端有被checked, 則會將內容存到陣列裡 ==========
		var testPersonDiv = document.getElementById("testPersonDiv");
		var testPersonChecks = testPersonDiv.querySelectorAll("input[type='checkbox']");

        for (var i = 0; i < testPersonChecks.length; i++){
        	if (testPersonChecks[i].checked == true){
        		testPersonSelected.push(testPersonChecks[i].value);

        	}
        }
		console.log("選取的試驗人員: " + testPersonSelected);
		
		
		var poleNumDiv = document.getElementById("poleNumDiv");
		var poleNumChecks = poleNumDiv.querySelectorAll("input[type='checkbox']");
		
		for (var i = 0; i < poleNumChecks.length; i++){
        	if (poleNumChecks[i].checked == true){
        		poleNumSelected.push(poleNumChecks[i].value);

        	}
        }
		console.log("選取的級數: " + poleNumSelected);
		
		
		var resultDiv = document.getElementById("resultDiv");
		var resultChecks = resultDiv.querySelectorAll("input[type='checkbox']");
		
		for (var i = 0; i < resultChecks.length; i++){
        	if (resultChecks[i].checked == true){
        		resultSelected.push(resultChecks[i].value);

        	}
        }
		console.log("選取的結果: " + resultSelected);
		
		var startDateSelected = document.getElementById("startDateSelected").value;
		console.log("start date: " + startDateSelected);
		
	  	var rowData = { // key開頭不能為大寫, 否則後端接收會為null
			'productType': productSelected,
			'poleNum': poleNumSelected,
		    'ammeter': ammeterSelected,
		    'testPerson': testPersonSelected,
		    'result': resultSelected, 
		};
		jsonArray.push(rowData);
		
		var jsonString = JSON.stringify(jsonArray); // 轉成 json 格式
		
		
		var formData = $("#myForm").serialize(); // $("#myForm") ->取得表單元素id的值, serialize() ->並將其序列化轉為字串
		//console.log(formData);
		$.ajax({
			url: "./viewjsonTestResult",
		  	type: 'POST',
		  	//contentType: "application/json", // 後端如果要以List接收, 這行必須要開
		  	dataType:"json", // 接收資料格式 (後端需有標註@ResponseBody的方法)
		  	data: formData,
		  	success: function(data) {
		  		//console.log(data);
		  		updateData(data);
		  		
		  	},
		  	error: function(xhr, status, error) {
			}
		});	
	}
	
	//AJAX向後端發送請求及接收重後端來的資料(此ajax方法為取得機種、日期、電流的陣列)
	$.ajax({
	    type:"GET",//請求方式
	    url:"./viewjsonSelectList",//url代表向後端發送請求 (後端需有標註@GetMapping("/viewjsonSelectList")的方法)
	    dataType:"json",//接收資料格式 (後端需有標註@ResponseBody的方法)
	    async:false,//false為非同步
	    success:function (result) {//接收後端來的資料
	    	//productTypeList = result["productType"];
	    	
	    	productTypeList = result.productType;
	    	ammeterList = result.ammeter;
	    	testPersonList = result.testPerson;	
	    	finishedTestDate = result.finishedTestDate;
	    	console.log("productTypeList: " + productTypeList);
	    	console.log("ammeterList: " + ammeterList);
	    	console.log("testPersonList: " + testPersonList);
	    	console.log("finishedTestDate: " + finishedTestDate);

	    },
	    error :function(errorMsg) {
	        alert("請求後端資料失敗！(viewjsonSelectList)");
	    }
	});
	
	// 自訂更新資料的函式, 可從後端接收來的數據, 渲染到html讀table上
    function updateData(data){
    	var innerTable = "";
    	innerTable += "<table border='1' class='styled-table'>";
    	//table title
    	innerTable += "<thead>";
    	innerTable += "<tr><td>編號</td><td>機種</td><td>極數</td><td>安培數</td><td>試驗人員</td><td>105%不跳脫</td><td>130%跳脫</td><td>結果</td><td>完成時間</td><td>備註</td>";
    	innerTable += "</thead>";
    	innerTable += "<tbody>";
    	for (var i = 0; i < data.length; i++) {
    		innerTable += "<tr class='active-row'>";

    		innerTable += "<td>" + data[i].id + "</td>";
    		innerTable += "<td>" + data[i].productType + "</td>";
    		innerTable += "<td>" + data[i].poleNum + "</td>";
    		innerTable += "<td>" + data[i].ammeter + "</td>";
    		innerTable += "<td>" + data[i].testPerson + "</td>";
    		innerTable += "<td>" + data[i].trip105 + "</td>";
    		innerTable += "<td>" + data[i].trip130 + "</td>";
    		innerTable += "<td>" + data[i].result + "</td>";
    		innerTable += "<td>" + formatDate(new Date(data[i].finishedTestTime)) + "</td>";
    		innerTable += "<td>" + data[i].testMessage + "</td>";
    	}
    	innerTable += "</tr>";
    	innerTable += "</tbody>";
    	innerTable += "</table>";
    	document.getElementById("tableDiv").innerHTML = innerTable;	
    }
	
	
	innerProduct();
	innerAnneter();
	innerTestPerson();
	
	//<input type="checkbox" name="productType" id=productSelected onchange="submitForm();">
	// ===== 啟動伺服器時會自動更新機種下拉式選單 =====
	function innerProduct(){
		var inner = ""; // 建立空變數, 存放所選取的值>
		var selectStr = "";
		for(var i=0; i<productTypeList.length; i++){
			inner = inner + "<label><input type='checkbox' name='productType' value='" + productTypeList[i] + "' onchange='submitForm();'>"
						  +  productTypeList[i] + "</label><br>";
		}
		var productSelect = document.getElementById("productDiv"); //取得機種下拉選單的元件名稱
		productSelect.innerHTML = inner; //傳進 HTML 裡進行渲染
	}
	
	function innerAnneter(){
		var inner = ""; // 建立空變數, 存放所選取的值>
		var selectStr = "";
		for(var i=0; i<ammeterList.length; i++){
			//inner = inner + "<option value=" + "'" + ammeterList[i] + "'"  + ">" + ammeterList[i] + "</option>";
			inner = inner + "<label><input type='checkbox' name='ammeter' value='" + ammeterList[i] + "' onchange='submitForm();'>"
						  + ammeterList[i] + "</label><br>";
		}
		var ammeterSelect = document.getElementById("ammeterDiv"); //取得機種下拉選單的元件名稱
		ammeterSelect.innerHTML = inner; //傳進 HTML 裡進行渲染
	}
	
	function innerTestPerson(){
		var inner = ""; // 建立空變數, 存放所選取的值>
		var selectStr = "";
		for(var i=0; i<testPersonList.length; i++){
			//inner = inner + "<option value=" + "'" + testPersonList[i] + "'"  + ">" + testPersonList[i] + "</option>";
			inner = inner + "<label><input type='checkbox' name='testPerson' value='" + testPersonList[i] + "' onchange='submitForm();'>"
						  + testPersonList[i] + "</label><br>";
		}
		var testPersonSelect = document.getElementById("testPersonDiv"); //取得機種下拉選單的元件名稱
		testPersonSelect.innerHTML = inner; //傳進 HTML 裡進行渲染
	}
	
	var startDateSelect = document.getElementById("startDateSelected"); //取得機種下拉選單的元件名稱
	startDateSelect.value = finishedTestDate[0]; //傳進 HTML 裡進行渲染
	var endDateSelect = document.getElementById("endDateSelected"); //取得機種下拉選單的元件名稱
	endDateSelect.value = finishedTestDate[1]; //傳進 HTML 裡進行渲染
	
	
	// ========== 時間格式轉換 ==========
	function padTo2Digits(num) {
		// 目標字串被填充到指定長度後，所得的新字串
		// padStart(指定長度, '填充的值') ex: '3'.padStart(2, '0'); //03
		return num.toString().padStart(2, '0');
	}

	function formatDate(date) {
		return (
			[
				date.getFullYear(),
				padTo2Digits(date.getMonth() + 1), //傳回值是一個0到11的正整數, 所以要+1
				padTo2Digits(date.getDate()), 
			].join('-') + //join()方法會將陣列或物件中所有的元素連接,並合併成一個新字串，回傳此新字串。 ['2022','06','02']->['2022-06-02']
			' ' +
			[
				padTo2Digits(date.getHours()),
				padTo2Digits(date.getMinutes()),
				padTo2Digits(date.getSeconds()),
			].join(':')
		);
	}
	
</script>

</body>

</html>